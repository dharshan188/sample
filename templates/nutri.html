<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NutriGuard AI</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>

  <!-- Right-side language selector (visible, sticky) -->
  <div class="lang-picker" id="langPicker" aria-label="Language picker">
    <button id="langBtn" title="Choose language" aria-haspopup="true" aria-expanded="false">
      <span class="lang-flag" id="langFlag">üåê</span>
      <span id="currentLang" class="lang-code">EN</span>
      <svg class="chev" width="12" height="12" viewBox="0 0 24 24" fill="none" aria-hidden>
        <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <div class="lang-menu" id="langMenu" role="menu" hidden>
      <button class="lang-option" data-lang="en" role="menuitem">EN ‚Äî English</button>
      <button class="lang-option" data-lang="hi" role="menuitem">HI ‚Äî ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
      <button class="lang-option" data-lang="te" role="menuitem">TE ‚Äî ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
    </div>
  </div>

  <div class="container">
    <div class="input-section" role="region" aria-labelledby="title">
      <h2 id="title">ü•ó NutriGuard AI ‚Äî Smart Nutrition Recommender</h2>

      <div class="user-inputs">
        <input type="number" id="height" placeholder="Height (cm)" aria-label="Height">
        <input type="number" id="weight" placeholder="Weight (kg)" aria-label="Weight">
        <select id="gender" aria-label="Gender">
          <option value="Male">Male ‚ôÇÔ∏è</option>
          <option value="Female">Female ‚ôÄÔ∏è</option>
        </select>
        <input type="text" id="city" placeholder="Enter your city" aria-label="City">
        <p class="small" id="qtyTip">Tip: Qty is interpreted as <strong>grams</strong> (e.g. 200 for 200g).</p>
      </div>

      <div id="food-list">
        <div class="food-item">
          <input type="text" placeholder="Food name" class="food-name" />
          <input type="number" placeholder="Qty (g)" class="food-qty" min="1" value="100" />
        </div>
      </div>

      <div class="controls">
        <button id="addBtn">‚ûï Add Another Food</button>
        <button id="analyzeBtn">Analyze üçΩÔ∏è</button>
      </div>
    </div>

    <div id="output" class="output-section" aria-live="polite"></div>
  </div>

<script>
/* ============================
   Full client-side localization
   ============================ */

/* Translation dictionaries:
   - UI strings
   - nutrient labels mapping
   - food name translations (recommendations)
*/
const translations = {
  en: {
    code: "EN", flag: "üåê",
    title: "ü•ó NutriGuard AI ‚Äî Smart Nutrition Recommender",
    heightPlaceholder: "Height (cm)",
    weightPlaceholder: "Weight (kg)",
    cityPlaceholder: "Enter your city",
    namePlaceholder: "Food name",
    qtyPlaceholder: "Qty (g)",
    qtyTip: "Tip: Qty is interpreted as <strong>grams</strong> (e.g. 200 for 200g).",
    addFood: "‚ûï Add Another Food",
    analyze: "Analyze üçΩÔ∏è",
    weatherHeading: (city) => `‚úÖ Weather in ${city}`,
    totalNutrients: "üìä Total Nutrients:",
    deficient: "üß© Deficient Nutrients:",
    allBalanced: "üéâ All nutrients balanced!",
    recommendations: "üç¥ Recommended Foods & Nutrients:",
    errorPrefix: "‚ùå",
    need_more: (nutrient, value) => `${nutrient}: need ${value} more`,
    nutrients: {
      "Protein": "Protein",
      "Vitamin C": "Vitamin C",
      "Iron": "Iron",
      "Calcium": "Calcium",
      "Fiber": "Fiber"
    },
    foods: {
      "Chicken": "Chicken",
      "Eggs": "Eggs",
      "Paneer": "Paneer",
      "Oats": "Oats",
      "Apple": "Apple",
      "Carrots": "Carrots",
      "Orange": "Orange",
      "Guava": "Guava",
      "Kiwi": "Kiwi",
      "Spinach": "Spinach",
      "Liver": "Liver",
      "Beans": "Beans",
      "Milk": "Milk",
      "Curd": "Curd",
      "Almonds": "Almonds"
    }
  },
  hi: {
    code: "HI", flag: "üåè",
    title: "ü•ó NutriGuard AI ‚Äî ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§™‡•ã‡§∑‡§£ ‡§∏‡•Å‡§ù‡§æ‡§µ‡§ï",
    heightPlaceholder: "‡§ä‡§Å‡§ö‡§æ‡§à (‡§∏‡•á‡§Æ‡•Ä)",
    weightPlaceholder: "‡§µ‡§ú‡§® (‡§ï‡§ø‡§≤‡•ã)",
    cityPlaceholder: "‡§Ö‡§™‡§®‡•á ‡§∂‡§π‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§°‡§æ‡§≤‡•á‡§Ç",
    namePlaceholder: "‡§ñ‡§æ‡§¶‡•ç‡§Ø ‡§®‡§æ‡§Æ",
    qtyPlaceholder: "‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (‡§ó‡•ç‡§∞‡§æ‡§Æ)",
    qtyTip: "‡§∏‡•Ç‡§ö‡§®‡§æ: ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§Æ‡•á‡§Ç ‡§π‡•à (‡§â‡§¶‡§æ., 200 = 200g)‡•§",
    addFood: "‚ûï ‡§î‡§∞ ‡§è‡§ï ‡§ú‡•ã‡§°‡§º‡•á‡§Ç",
    analyze: "‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç üçΩÔ∏è",
    weatherHeading: (city) => `‚úÖ ‡§Æ‡•å‡§∏‡§Æ ‚Äî ${city}`,
    totalNutrients: "üìä ‡§ï‡•Å‡§≤ ‡§™‡•ã‡§∑‡§ï ‡§§‡§§‡•ç‡§µ:",
    deficient: "üß© ‡§ï‡§Æ ‡§™‡•ã‡§∑‡§ï ‡§§‡§§‡•ç‡§µ:",
    allBalanced: "üéâ ‡§∏‡§≠‡•Ä ‡§™‡•ã‡§∑‡§ï ‡§§‡§§‡•ç‡§µ ‡§∏‡§Ç‡§§‡•Å‡§≤‡§ø‡§§ ‡§π‡•à‡§Ç!",
    recommendations: "üç¥ ‡§∏‡•Å‡§ù‡§æ‡§è ‡§ó‡§è ‡§ñ‡§æ‡§¶‡•ç‡§Ø ‡§™‡§¶‡§æ‡§∞‡•ç‡§• ‡§î‡§∞ ‡§™‡•ã‡§∑‡§ï ‡§§‡§§‡•ç‡§µ:",
    errorPrefix: "‚ùå",
    need_more: (nutrient, value) => `${nutrient}: ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ${value} ‡§Ö‡§ß‡§ø‡§ï`,
    nutrients: {
      "Protein": "‡§™‡•ç‡§∞‡•ã‡§ü‡•Ä‡§®",
      "Vitamin C": "‡§µ‡§ø‡§ü‡§æ‡§Æ‡§ø‡§® C",
      "Iron": "‡§Ü‡§Ø‡§∞‡§®",
      "Calcium": "‡§ï‡•à‡§≤‡•ç‡§∂‡§ø‡§Ø‡§Æ",
      "Fiber": "‡§´‡§æ‡§á‡§¨‡§∞"
    },
    foods: {
      "Chicken": "‡§ö‡§ø‡§ï‡§®",
      "Eggs": "‡§Ö‡§Ç‡§°‡•á",
      "Paneer": "‡§™‡§®‡•Ä‡§∞",
      "Oats": "‡§ì‡§ü‡•ç‡§∏",
      "Apple": "‡§∏‡•á‡§¨",
      "Carrots": "‡§ó‡§æ‡§ú‡§∞",
      "Orange": "‡§∏‡§Ç‡§§‡§∞‡§æ",
      "Guava": "‡§™‡•á‡§∞‡§ø‡§ö / ‡§Ö‡§Æ‡§∞‡•Ç‡§¶", // regional variant ok
      "Kiwi": "‡§ï‡•Ä‡§µ‡•Ä",
      "Spinach": "‡§™‡§æ‡§≤‡§ï",
      "Liver": "‡§≤‡•Ä‡§µ‡§∞",
      "Beans": "‡§¨‡•Ä‡§®‡•ç‡§∏",
      "Milk": "‡§¶‡•Ç‡§ß",
      "Curd": "‡§¶‡§π‡•Ä",
      "Almonds": "‡§¨‡§æ‡§¶‡§æ‡§Æ"
    }
  },
  te: {
    code: "TE", flag: "üåè",
    title: "ü•ó NutriGuard AI ‚Äî ‡∞∏‡±ç‡∞Æ‡∞æ‡∞∞‡±ç‡∞ü‡±ç ‡∞™‡±ã‡∞∑‡∞£ ‡∞∏‡∞≤‡∞π‡∞æ‡∞¶‡∞æ‡∞∞‡±Å",
    heightPlaceholder: "‡∞é‡∞§‡±ç‡∞§‡±Å (‡∞∏‡±Ü‡∞Ç.‡∞Æ‡±Ä)",
    weightPlaceholder: "‡∞¨‡∞∞‡±Å‡∞µ‡±Å (kg)",
    cityPlaceholder: "‡∞Æ‡±Ä ‡∞®‡∞ó‡∞∞‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
    namePlaceholder: "‡∞Ü‡∞π‡∞æ‡∞∞ ‡∞™‡±á‡∞∞‡±Å",
    qtyPlaceholder: "‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç (‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡±Å‡∞≤‡±Å)",
    qtyTip: "‡∞ó‡∞Æ‡∞®‡∞ø‡∞ï: ‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç ‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡±Å‡∞≤‡±ç‡∞≤‡±ã (‡∞â‡∞¶‡∞æ., 200 = 200g).",
    addFood: "‚ûï ‡∞Æ‡∞∞‡±ä‡∞ï‡∞ü‡∞ø ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø",
    analyze: "‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞ø‡∞Ç‡∞ö‡±Å üçΩÔ∏è",
    weatherHeading: (city) => `‚úÖ ‡∞µ‡∞æ‡∞§‡∞æ‡∞µ‡∞∞‡∞£‡∞Ç ‚Äî ${city}`,
    totalNutrients: "üìä ‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞™‡±ã‡∞∑‡∞ï‡∞æ‡∞≤‡±Å:",
    deficient: "üß© ‡∞≤‡±ã‡∞™‡∞æ‡∞≤‡±Å ‡∞â‡∞®‡±ç‡∞® ‡∞™‡±ã‡∞∑‡∞ï‡∞æ‡∞≤‡±Å:",
    allBalanced: "üéâ ‡∞Ö‡∞®‡±ç‡∞®‡∞ø ‡∞™‡±ã‡∞∑‡∞ï‡∞æ‡∞≤‡±Å ‡∞∏‡∞Æ‡∞§‡±Å‡∞≤‡±ç‡∞Ø‡∞Ç‡∞ó‡∞æ ‡∞â‡∞®‡±ç‡∞®‡∞µ‡∞ø!",
    recommendations: "üç¥ ‡∞∏‡±Ç‡∞ö‡∞ø‡∞Ç‡∞ö‡∞ø‡∞® ‡∞Ü‡∞π‡∞æ‡∞∞‡∞æ‡∞≤‡±Å & ‡∞™‡±ã‡∞∑‡∞ï‡∞æ‡∞≤‡±Å:",
    errorPrefix: "‚ùå",
    need_more: (nutrient, value) => `${nutrient}: ‡∞Ö‡∞µ‡∞∏‡∞∞‡∞Ç ${value} ‡∞é‡∞ï‡±ç‡∞ï‡±Å‡∞µ`,
    nutrients: {
      "Protein": "‡∞™‡±ç‡∞∞‡±ã‡∞ü‡±Ä‡∞®‡±ç",
      "Vitamin C": "‡∞µ‡∞ø‡∞ü‡∞Æ‡∞ø‡∞®‡±ç C",
      "Iron": "‡∞ê‡∞∞‡∞®‡±ç",
      "Calcium": "‡∞ï‡∞æ‡∞≤‡±ç‡∞∑‡∞ø‡∞Ø‡∞Ç",
      "Fiber": "‡∞´‡±à‡∞¨‡∞∞‡±ç"
    },
    foods: {
      "Chicken": "‡∞ö‡∞ø‡∞ï‡±Ü‡∞®‡±ç",
      "Eggs": "‡∞ó‡±Å‡∞°‡±ç‡∞≤‡±Å",
      "Paneer": "‡∞™‡∞®‡±Ä‡∞∞‡±Å",
      "Oats": "‡∞ì‡∞ü‡±ç‡∞∏‡±ç",
      "Apple": "‡∞Ü‡∞™‡∞ø‡∞≤‡±ç",
      "Carrots": "‡∞ï‡±ç‡∞Ø‡∞æ‡∞∞‡±Ü‡∞ü‡±ç",
      "Orange": "‡∞Ü‡∞∞‡±Ü‡∞Ç‡∞ú‡±ç",
      "Guava": "‡∞™‡±Ü‡∞∞‡±Å‡∞ó‡±Å / ‡∞ú‡∞æ‡∞Æ",
      "Kiwi": "‡∞ï‡∞ø‡∞µ‡∞ø",
      "Spinach": "‡∞™‡∞æ‡∞≤‡∞ï‡±Ç‡∞∞",
      "Liver": "‡∞≤‡∞ø‡∞µ‡∞∞‡±ç",
      "Beans": "‡∞¨‡±Ä‡∞®‡±ç‡∞∏‡±ç",
      "Milk": "‡∞™‡∞æ‡∞≤",
      "Curd": "‡∞§‡∞Ø‡∞æ‡∞Ç‡∞¨‡±Å / ‡∞™‡±Ü‡∞∞‡±Å‡∞ó‡±Å",
      "Almonds": "‡∞¨‡∞æ‡∞¶‡∞æ‡∞Ç"
    }
  }
};

/* Persisted language in localStorage */
const LS_KEY = "nutri_lang";
let currentLang = localStorage.getItem(LS_KEY) || "en";

/* Helpers to get translations easily */
function t(key) {
  return translations[currentLang][key];
}
function trNutrient(key) {
  return translations[currentLang].nutrients[key] || key;
}
function trFood(key) {
  return translations[currentLang].foods[key] || key;
}

/* UI elements */
const langBtn = document.getElementById("langBtn");
const langMenu = document.getElementById("langMenu");
const currentLangEl = document.getElementById("currentLang");
const langFlagEl = document.getElementById("langFlag");

/* Setup language picker visible and interactive */
function applyLangToPicker() {
  currentLangEl.textContent = translations[currentLang].code;
  langFlagEl.textContent = translations[currentLang].flag || "üåê";
}
applyLangToPicker();

/* Open/close menu */
langBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  const expanded = langBtn.getAttribute("aria-expanded") === "true";
  langBtn.setAttribute("aria-expanded", (!expanded).toString());
  langMenu.hidden = !langMenu.hidden;
});
document.addEventListener("click", () => { langMenu.hidden = true; langBtn.setAttribute("aria-expanded","false"); });

document.querySelectorAll(".lang-option").forEach(btn => {
  btn.addEventListener("click", () => {
    const lang = btn.getAttribute("data-lang");
    setLanguage(lang);
    langMenu.hidden = true;
    langBtn.setAttribute("aria-expanded","false");
  });
});

/* Apply translations to all static UI elements */
function applyTranslations() {
  const dict = translations[currentLang];
  document.getElementById("title").innerHTML = dict.title;
  document.getElementById("height").placeholder = dict.heightPlaceholder;
  document.getElementById("weight").placeholder = dict.weightPlaceholder;
  document.getElementById("city").placeholder = dict.cityPlaceholder;
  document.querySelectorAll(".food-name").forEach(el => el.placeholder = dict.namePlaceholder);
  document.querySelectorAll(".food-qty").forEach(el => el.placeholder = dict.qtyPlaceholder);
  document.getElementById("qtyTip").innerHTML = dict.qtyTip;
  document.getElementById("addBtn").textContent = dict.addFood;
  document.getElementById("analyzeBtn").textContent = dict.analyze;
  applyLangToPicker();
}

/* Set and persist language */
function setLanguage(lang) {
  if (!translations[lang]) lang = "en";
  currentLang = lang;
  localStorage.setItem(LS_KEY, lang);
  applyTranslations();
}

/* Initial apply */
setLanguage(currentLang);

/* Add another food row */
function addFood() {
  const list = document.getElementById("food-list");
  const div = document.createElement("div");
  div.classList.add("food-item");
  div.innerHTML = `
    <input type="text" placeholder="${translations[currentLang].namePlaceholder}" class="food-name" />
    <input type="number" placeholder="${translations[currentLang].qtyPlaceholder}" class="food-qty" min="1" value="100" />
  `;
  list.appendChild(div);
}

/* Render output fully localized */
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}

function renderOutput(data, city) {
  const dict = translations[currentLang];
  const out = document.getElementById("output");
  const weather = data.weather || null;
  let html = "";

  // Weather header (localized)
  const weatherHeading = dict.weatherHeading(city || (weather && weather.location) || "");
  html += `<h3>${escapeHtml(weatherHeading)}</h3>`;
  if (weather) {
    html += `<p>üå§ ${escapeHtml(weather.condition)}, üå° ${escapeHtml(String(weather.temp))}¬∞C, üíß ${escapeHtml(String(weather.humidity))}%</p>`;
  }

  // Total nutrients
  html += `<h3>${dict.totalNutrients}</h3>`;
  const totals = data.total_nutrients || {};
  if (!Object.keys(totals).length) {
    html += `<p>-</p>`;
  } else {
    html += `<ul>`;
    for (const [k, v] of Object.entries(totals)) {
      html += `<li><strong>${escapeHtml(trNutrient(k))}:</strong> ${escapeHtml(v)}</li>`;
    }
    html += `</ul>`;
  }

  // Deficiencies
  html += `<h3>${dict.deficient}</h3>`;
  const deficient = data.deficient || {};
  if (!Object.keys(deficient).length) {
    html += `<p>${dict.allBalanced}</p>`;
  } else {
    html += `<ul>`;
    for (const [k, v] of Object.entries(deficient)) {
      const label = trNutrient(k);
      html += `<li>${escapeHtml(dict.need_more(label, v))}</li>`;
    }
    html += `</ul>`;
  }

  // Recommendations
  html += `<h3>${dict.recommendations}</h3>`;
  const recs = data.recommendations || [];
  if (!recs.length) {
    html += `<p>-</p>`;
  } else {
    html += `<ul>`;
    recs.forEach(item => {
      // item could be [name, amt] or [name, amt, unit] or [name, '-', '-']
      const name = item[0] || "";
      const amt = item[1] || "";
      // translate food name if we have mapping
      const nameLocal = trFood(name);
      html += `<li>${escapeHtml(nameLocal)}${amt && amt !== "-" ? " ‚Äî " + escapeHtml(amt) : ""}</li>`;
    });
    html += `</ul>`;
  }

  out.innerHTML = html;
}

/* POST to /analyze and render localized output */
async function analyze() {
  const city = document.getElementById("city").value.trim();
  const gender = document.getElementById("gender").value;
  const height = document.getElementById("height").value;
  const weight = document.getElementById("weight").value;
  const foodNames = document.querySelectorAll(".food-name");
  const foodQtys = document.querySelectorAll(".food-qty");

  const items = [];
  for (let i = 0; i < foodNames.length; i++) {
    const name = foodNames[i].value.trim();
    const qty = foodQtys[i].value;
    if (name) items.push({ name, qty });
  }

  const payload = { city, gender, height, weight, items, lang: currentLang };
  const outEl = document.getElementById("output");
  outEl.innerHTML = `<p>‚è≥ ...</p>`;

  try {
    const res = await fetch("/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (data.error) {
      outEl.innerHTML = `<p style="color:red;">${escapeHtml(translations[currentLang].errorPrefix)} ${escapeHtml(data.error)}</p>`;
      return;
    }
    renderOutput(data, city);
  } catch (err) {
    outEl.innerHTML = `<p style="color:red;">${escapeHtml(translations[currentLang].errorPrefix)} ${escapeHtml(err.message || String(err))}</p>`;
  }
}

/* wiring */
document.getElementById("addBtn").addEventListener("click", addFood);
document.getElementById("analyzeBtn").addEventListener("click", analyze);

/* keep language across reloads */
applyTranslations();
</script>

</body>
</html>
